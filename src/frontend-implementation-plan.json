{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix AuthProvider mounting and enforce post-login hash navigation to leave LoginScreen",
  "requirements": [
    {
      "id": "REQ-14",
      "summary": "Mount the React app with AuthProvider at the application root so useAuth() reflects real auth state and successful login triggers UI transitions.",
      "acceptanceCriteria": [
        "`frontend/src/main.tsx` renders a non-empty React tree that includes `<App />`.",
        "`AuthProvider` from `frontend/src/contexts/AuthContext.tsx` wraps `<App />` (directly or indirectly) so that `useAuth()` in `App.tsx` and `LoginScreen.tsx` is backed by the real provider rather than default context values.",
        "After a successful login (manual credentials or badge scan), `auth` becomes truthy in `App.tsx` and the UI no longer remains on `LoginScreen`."
      ],
      "file_operations": [
        {
          "path": "frontend/src/main.tsx",
          "operation": "modify",
          "description": "Wrap <App /> with AuthProvider from frontend/src/contexts/AuthContext.tsx while preserving the existing QueryClientProvider and InternetIdentityProvider wrappers, so AuthContext state updates propagate to App.tsx/LoginScreen.tsx and allow navigation past the login screen."
        }
      ]
    },
    {
      "id": "REQ-15",
      "summary": "Make App.tsx consistently redirect authenticated users to a valid signed-in hash route and render signed-in route content whenever auth is truthy without breaking the refresh/reconnecting overlay behavior.",
      "acceptanceCriteria": [
        "With `window.location.hash` empty or invalid, logging in successfully results in navigation to `#roleSelection` and the Role Selection screen is rendered (not the login screen).",
        "With a valid signed-in hash route already set (e.g. `#agentMenu`), logging in successfully keeps or navigates to a valid signed-in screen instead of remaining on `LoginScreen`.",
        "The reconnecting/refresh overlay behavior (`subscribeToRefreshState`, timeout auto-dismiss, manual dismiss) continues to work both when logged out (LoginScreen) and when signed in."
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Harden the hash-based signed-in routing logic so that as soon as useAuth().auth becomes truthy, App enforces navigation to a valid signed-in hash route (defaulting to roleSelection when empty/invalid), keeps valid signed-in hashes intact, and always renders signed-in route content when auth is truthy; ensure the existing refresh/reconnecting overlay subscription + timeout/manual dismiss behavior remains unchanged across both logged-out and signed-in renders."
        }
      ]
    }
  ]
}