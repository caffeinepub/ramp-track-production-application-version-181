{
  "kind": "build_request",
  "title": "Patch login flow so the app always transitions beyond LoginScreen after successful sign-in",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-14",
      "text": "Update `frontend/src/main.tsx` so the React app is mounted with `AuthProvider` enabled at the application root (wrapping `<App />`), while preserving the existing `QueryClientProvider` and `InternetIdentityProvider` wrappers, so that `useAuth()` state updates (including successful login) can drive UI transitions beyond the login screen.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-1"
        ],
        "quotes": [
          "So I need a patch that fixes all of the issues and guarantees I'll get beyond the login"
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/main.tsx` renders a non-empty React tree that includes `<App />`.",
        "`AuthProvider` from `frontend/src/contexts/AuthContext.tsx` wraps `<App />` (directly or indirectly) so that `useAuth()` in `App.tsx` and `LoginScreen.tsx` is backed by the real provider rather than default context values.",
        "After a successful login (manual credentials or badge scan), `auth` becomes truthy in `App.tsx` and the UI no longer remains on `LoginScreen`."
      ]
    },
    {
      "id": "REQ-15",
      "text": "Ensure `frontend/src/App.tsx` reliably transitions away from `LoginScreen` as soon as `useAuth().auth` becomes truthy, by enforcing the existing hash-based navigation behavior that redirects authenticated users to a valid signed-in route (defaulting to `roleSelection`) when the current URL hash is empty or invalid, and by rendering the signed-in route content whenever `auth` is truthy.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-1"
        ],
        "quotes": [
          "So I need a patch that fixes all of the issues and guarantees I'll get beyond the login"
        ]
      },
      "acceptanceCriteria": [
        "With `window.location.hash` empty or invalid, logging in successfully results in navigation to `#roleSelection` and the Role Selection screen is rendered (not the login screen).",
        "With a valid signed-in hash route already set (e.g. `#agentMenu`), logging in successfully keeps or navigates to a valid signed-in screen instead of remaining on `LoginScreen`.",
        "The reconnecting/refresh overlay behavior (`subscribeToRefreshState`, timeout auto-dismiss, manual dismiss) continues to work both when logged out (LoginScreen) and when signed in."
      ]
    }
  ],
  "constraints": [
    "Frontend must remain React + TypeScript with Tailwind and React Query.",
    "Do not modify any files under `frontend/src/components/ui` (read-only components).",
    "Backend must remain a single Motoko actor; do not introduce additional backend services."
  ],
  "nonGoals": [
    "Implementing Internet Identity sign-in UX (calling `useInternetIdentity().login()`) or changing authentication mechanisms beyond fixing the current login transition.",
    "Refactoring storage key conventions across the app (e.g., `ramptrack_v2_session` vs `ramptrack_auth_state`) unless required to fix the login-to-signed-in transition.",
    "Adding new admin/operator features unrelated to getting past login."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}