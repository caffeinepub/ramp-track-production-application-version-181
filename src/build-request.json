{
  "kind": "build_request",
  "title": "Fix post-login navigation so the app reliably leaves the Login screen",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-12",
      "text": "Update `frontend/src/main.tsx` to mount `AuthProvider` from `./contexts/AuthContext` around the entire application so `useAuth()` can update `auth` and the UI can transition beyond `LoginScreen`. Preserve the existing `QueryClientProvider` and `InternetIdentityProvider` wrappers, and keep user-facing behavior unchanged aside from fixing the login flow.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-User-1"
        ],
        "quotes": [
          "Build it",
          "Yes. Do whatever it takes to get beyond the login"
        ]
      },
      "acceptanceCriteria": [
        "`frontend/src/main.tsx` renders a non-empty React tree that includes `<App />` wrapped with `<AuthProvider>`.",
        "After a successful login (manual, camera badge scan, or keyboard-wedge scan), `useAuth().auth` becomes truthy and `App.tsx` re-renders into the signed-in UI instead of remaining on `LoginScreen`.",
        "No changes are made to any files under `frontend/src/hooks/useInternetIdentity.ts` / `useActor.ts` or `frontend/src/components/ui` (immutable paths)."
      ]
    },
    {
      "id": "REQ-13",
      "text": "Update `frontend/src/App.tsx` so that when `auth` becomes truthy, the app automatically navigates to a valid signed-in route (defaulting to `roleSelection`) if the current URL hash is empty or invalid, ensuring the app cannot remain on the logged-out `LoginScreen` after a successful login. Keep the existing hash-based routing structure and preserve the reconnecting/refresh overlay behavior.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-User-1"
        ],
        "quotes": [
          "It still doesn't go beyond the login screen. Why? Thought you fixed it",
          "Yes. Do whatever it takes to get beyond the login"
        ]
      },
      "acceptanceCriteria": [
        "When `auth` transitions from falsy to truthy, the app renders the signed-in flow and sets `window.location.hash` to a valid view (at minimum `#roleSelection`) if none is present.",
        "If the URL hash is already a valid signed-in view, the app does not override it on auth changes.",
        "The reconnecting/refresh overlay continues to work on both logged-out (`LoginScreen`) and signed-in screens (including subscribe-to-refresh-state behavior, auto-dismiss timeout, and user dismiss)."
      ]
    }
  ],
  "constraints": [
    "Use English for any user-facing text.",
    "Frontend immutable paths must not be edited: `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`, `frontend/src/components/ui` are restricted only as specified by SYSTEM_CONTEXT (compose UI components; do not edit `frontend/src/components/ui`).",
    "Backend must remain single-actor; no backend changes are required for this fix."
  ],
  "nonGoals": [
    "Implementing or changing Internet Identity login UI/flow.",
    "Changing authentication logic inside `frontend/src/contexts/AuthContext.tsx` beyond what is necessary to mount the provider.",
    "Replacing hash-based navigation with a different routing solution.",
    "Adding new features unrelated to leaving the login screen (e.g., new admin tools, scanner enhancements, new dashboards)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}